{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Polynomial Curve Fitting</h2>
    <form id="polynomialForm" class="border p-4 rounded bg-light">
        <!-- Number of Data Points -->
        <div class="mb-3">
            <label for="num_points" class="form-label">Number of Data Points:</label>
            <select id="num_points" name="num_points" class="form-select">
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
        </div>
        <!-- Dynamic Input Fields -->
        <div id="data_input">
            <h4>Data Points:</h4>
            <table class="table table-bordered">
                {% for i in range(4) %}
                <tr>
                    <td>
                        <input type="number" step="any" name="x_{{i}}" placeholder="x[{{i}}]" class="form-control">
                    </td>
                    <td>
                        <input type="number" step="any" name="y_{{i}}" placeholder="y[{{i}}]" class="form-control">
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
        <!-- Polynomial Degree -->
        <div class="mb-3">
            <label for="degree" class="form-label">Polynomial Degree:</label>
            <input type="number" id="degree" name="degree" value="3" min="1" class="form-control" required>
        </div>
        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary w-100">Fit Polynomial</button>
    </form>
    <!-- Results Section -->
    <div class="mt-4" id="resultsSection" style="display: none;">
        <h3>Results:</h3>
        <p><strong>Fitted Polynomial Equation:</strong> <span id="equationResult"></span></p>
        <canvas id="solutionChart"></canvas>
        <p><strong>Description:</strong> The red curve represents the fitted polynomial equation.
            The blue dots are the original data points provided by the user.</p>
    </div>
    <!-- Error Section -->
    <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const numPointsSelector = document.getElementById('num_points');
    const dataInputDiv = document.getElementById('data_input');

    // Function to dynamically update input fields
    function updateInputs(numPoints) {
        dataInputDiv.innerHTML = '';
        const table = document.createElement('table');
        table.classList.add('table', 'table-bordered');
        for (let i = 0; i < numPoints; i++) {
            const row = document.createElement('tr');
            const xCell = document.createElement('td');
            const xInput = document.createElement('input');
            xInput.type = 'number';
            xInput.step = 'any';
            xInput.name = `x_${i}`;
            xInput.placeholder = `x[${i}]`;
            xInput.classList.add('form-control');
            xCell.appendChild(xInput);
            row.appendChild(xCell);

            const yCell = document.createElement('td');
            const yInput = document.createElement('input');
            yInput.type = 'number';
            yInput.step = 'any';
            yInput.name = `y_${i}`;
            yInput.placeholder = `y[${i}]`;
            yInput.classList.add('form-control');
            yCell.appendChild(yInput);
            row.appendChild(yCell);

            table.appendChild(row);
        }
        dataInputDiv.appendChild(table);
    }

    // Initial call to set up inputs for default number of points
    updateInputs(parseInt(numPointsSelector.value));

    // Add event listener for number of points change
    numPointsSelector.addEventListener('change', function () {
        const numPoints = parseInt(this.value);
        updateInputs(numPoints);
    });

    // Handle form submission
    document.getElementById('polynomialForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        fetch('/polynomial-curve-fitting', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('errorMessage').textContent = data.error;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('resultsSection').style.display = 'none';
                return;
            }

            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            // Display the equation
            document.getElementById('equationResult').textContent = data.equation;

            // Plot the chart
            const ctx = document.getElementById('solutionChart').getContext('2d');
            if (window.chart) {
                window.chart.destroy();
            }

            // Round x-values to 2 decimal places
            const roundedXValues = data.x_fit.map(x => parseFloat(x).toFixed(2));

            window.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: roundedXValues,
                    datasets: [
                        {
                            label: 'Fitted Curve',
                            data: data.y_fit,
                            borderColor: 'red',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Data Points',
                            data: data.x_data.map((x, i) => ({ x: parseFloat(x).toFixed(2), y: parseFloat(data.y_data[i]).toFixed(2) })),
                            borderColor: 'blue',
                            backgroundColor: 'blue',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'X-axis'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Y-axis'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error:', error); // Log the error to the console
            document.getElementById('errorMessage').textContent = 'An error occurred. Please try again.';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        });
    });
});
</script>
{% endblock %}